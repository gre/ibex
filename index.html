<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>JS13K</title>
  <link rel="stylesheet" href="index.css">
</head>
<body>
  <canvas id="C"></canvas>
  <script id="vertexLogic" type="x-shader/x-vertex">
    attribute vec2 position;
    void main() {
      gl_Position = vec4(2.0*position-1.0, 0.0, 1.0);
    }
  </script>
  <script id="fragmentLogic" type="x-shader/x-fragment">
    #define AC(a) if(r==a)c=colors[a];
  
    precision highp float;
    uniform vec2 size;
    uniform float time;
    uniform sampler2D state;

    uniform vec3 colors[5];

    float rand(vec2 co){
      return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);
    }

    vec4 getColor(ivec2 position) {
      return texture2D(state, (gl_FragCoord.xy + vec2(position)) / size);
    }
    int get (ivec2 position) {
      vec3 cmp = getColor(position).rgb;
      for (int i=0; i<5; ++i) {
        vec3 ref = colors[i];
        if (distance(cmp, ref) < 0.01)
          return i;
      }
      return 0;
    }
    int get (int x, int y) {
      return get(ivec2(x, y));
    }

    void main () {
      float o = rand(gl_FragCoord.xy + time * 0.1);
      float oo = rand(gl_FragCoord.xy + time * 9.1 + 13.91);

      int e; // element
      int r = 0;

      int me = get(0, 0);
      int up = get(0, 1);
      int upl = get(-1, 1);
      int upr = get(1, 1);
      int dow = get(0, -1);
      int dol = get(-1, -1);
      int dor = get(1, -1);

      //////// FIRE RULES ///////
      e = 2;

      float frr = 0.04; // fire randomness
      float frh = 0.03; // fire hole

      if (dow == 1)
        r = e;
      else if (dow == e)
        r = e;

      if (dol == e && o < frr)
        r = e;

      if (dor == e && 1.0-o < frr)
        r = e;

      if (dol == e && dor == e && dow == e && oo < frh)
        r = me;

      ////// WATER RULES ///////
      e = 3;
      float wfr = 0.04; // waterfall randomness
      float wfh = 0.03; // waterfall hole

      if (up == 1)
        r = e;
      else if (up == e)
        r = e;

      if (upl == e && o < wfr)
        r = e;

      if (upr == e && 1.0-o < wfr)
        r = e;

      if (upl == e && upr == e && up == e && oo < wfh)
        r = me;

      ////// ROCK RULES ///////

      if (me == 1)
        r = 1;

      ///// Return the color result /////

      vec3 c;AC(0)AC(1)AC(2)AC(3)AC(4)gl_FragColor=vec4(c,1.0); //: gl_FragColor=vec4(colors[r], 1.0);
    }
  </script>
  
  <script id="vertexRender" type="x-shader/x-vertex">
    attribute vec2 position; void main() { gl_Position = vec4(2.0*position-1.0, 0.0, 1.0);}
  </script>
  <script id="fragmentRender" type="x-shader/x-fragment">
    precision highp float;
    uniform vec2 size;
    uniform vec2 resolution;
    uniform float time;
    uniform sampler2D logic;
    
    void main () {
      gl_FragColor = texture2D(logic, floor(gl_FragCoord.xy) / resolution);
    }
  </script>
  <script src="index.js"></script>
</body>
</html>
