<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>JS13K</title>
  <link rel="stylesheet" href="index.css">
</head>
<body>
  <canvas id="C"></canvas>
  <script id="vertexLogic" type="x-shader/x-vertex">
    attribute vec2 position;
    void main() {
      gl_Position = vec4(2.0*position-1.0, 0.0, 1.0);
    }
  </script>
  <script id="fragmentLogic" type="x-shader/x-fragment">
    precision highp float;
    uniform vec2 size;
    uniform float time;
    uniform sampler2D state;

    uniform vec3 colors[5];

    vec4 getColor(vec2 position) {
      return texture2D(state, (gl_FragCoord.xy + position) / size);
    }
    int get (vec2 position) {
      vec3 cmp = getColor(position).rgb;
      for (int i=0; i<5; ++i) {
        vec3 ref = colors[i];
        if (distance(cmp, ref) < 0.01)
          return i;
      }
      return 0;
    }
    
    void main () {
      int sum = get(vec2(-1.0, -1.0)) + get(vec2(0.0, -1.0)) + get(vec2(1.0, -1.0)) +
        get(vec2(-1.0, 0.0)) + get(vec2(1.0, 0.0)) +
        get(vec2(-1.0, 1.0)) + get(vec2(0.0, 1.0)) + get(vec2(1.0, 1.0));
      int last = get(vec2(0.0, 0.0));
      int current = 0;
      if ((last == 0 && sum == 3) || (last == 1 && (sum == 2 || sum == 3))) {
        current = 1;
      }
      //gl_FragColor = vec4(vec3(float(current)), 1.0);
      //gl_FragColor = getColor(vec2(0.0));
      //gl_FragColor = vec4(colors[get(vec2(0.0))], 1.0);
      if ((last == 0 && 4 <= sum && sum <= 5) || (last == 1 && (sum >= 4 && sum <= 12))) {
        if (sum == 1 || sum == 4 || sum == 7 || sum == 11)
          gl_FragColor = vec4(colors[1], 1.0);
        else if (sum == 0 || sum == 3 || sum == 6 || sum == 10)
          gl_FragColor = vec4(colors[2], 1.0);
        else
          gl_FragColor = vec4(colors[3], 1.0);
      }
      else {
        gl_FragColor = vec4(colors[0], 1.0);
      }
    }
  </script>
  
  <script id="vertexRender" type="x-shader/x-vertex">
    attribute vec2 position; void main() { gl_Position = vec4(2.0*position-1.0, 0.0, 1.0);}
  </script>
  <script id="fragmentRender" type="x-shader/x-fragment">
    precision highp float;
    uniform vec2 size;
    uniform vec2 resolution;
    uniform float time;
    uniform sampler2D logic;
    
    void main () {
      gl_FragColor = texture2D(logic, gl_FragCoord.xy / resolution);
    }
  </script>
  <script src="index.js"></script>
</body>
</html>
